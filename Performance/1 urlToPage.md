## 用户输入url后会发生什么

当用户在浏览器的地址栏中输入一个URL并按下回车键后，浏览器会经历一系列复杂的步骤，最终将网页呈现在用户面前。作为一名前端工程师，了解这一过程的每个环节对于优化网站性能、提升用户体验至关重要。

---

### 用户输URL后经历环节如下
## 一、URL解析和DNS查询

### 1. URL解析

首先，浏览器需要解析用户输入的URL（例如`https://www.example.com`），将其拆分为以下部分：

- **协议（Scheme）**：`https`
- **域名（Host）**：`www.example.com`
- **端口号（Port）**：默认为443（HTTPS）或80（HTTP）
- **路径（Path）**：如果有，例如`/index.html`
- **查询参数（Query Parameters）**：例如`?id=1`
- **片段标识符（Fragment Identifier）**：例如`#section1`

### 2. DNS查询

为了找到目标服务器的IP地址，浏览器需要进行DNS解析：

1. **检查浏览器缓存**：浏览器会先检查本地缓存中是否有对应的IP地址。
2. **检查操作系统缓存**：如果浏览器缓存未命中，会查询操作系统的DNS缓存。
3. **读取本地hosts文件**：操作系统会检查`hosts`文件，看是否有手动配置的域名-IP映射。
4. **向DNS服务器查询**：如果仍未找到，操作系统会向预配置的DNS服务器发送查询请求。

DNS解析的结果是获取域名对应的IP地址，例如`93.184.216.34`。

---

## 二、建立TCP连接

### 1. 三次握手

有了目标IP地址后，浏览器会通过TCP/IP协议与服务器建立连接，过程如下：

1. **客户端发送SYN包**：请求建立连接。
2. **服务器返回SYN-ACK包**：确认收到请求，并同意建立连接。
3. **客户端发送ACK包**：确认连接建立。

这就是所谓的“三次握手”过程，目的是确保客户端和服务器之间的连接可靠。

### 2. TLS握手（如果是HTTPS）

如果使用的是HTTPS协议，还需要在TCP连接之上建立TLS加密通道：

1. **协议协商**：客户端和服务器协商使用的TLS版本和加密套件。
2. **证书验证**：服务器向客户端提供数字证书，客户端验证其有效性和可信度。
3. **密钥交换**：双方生成对称加密密钥，用于后续的数据加密传输。

---

## 三、发送HTTP请求

### 1. 构建请求报文

浏览器构建HTTP请求报文，包括：

- **请求行**：请求方法、请求URI、HTTP版本。
- **请求头部**：包括Host、User-Agent、Accept等信息。
- **空行**：用于分隔头部和主体。
- **请求主体**：一般用于POST请求，包含提交的数据。

### 2. 发送请求

浏览器将构建好的请求报文通过已建立的TCP连接发送给服务器。

---

## 四、服务器处理请求并返回响应

### 1. 请求处理

服务器接收到请求后，进行以下处理：

- **解析请求**：读取请求行和请求头，获取请求方法、资源路径等信息。
- **路由分发**：根据请求的路径，将请求分发给对应的处理程序或控制器。
- **业务处理**：服务器可能需要查询数据库、调用后台服务或执行其他逻辑。
- **生成响应**：构建HTTP响应报文，包括状态行、响应头和响应主体。

### 2. 返回响应

服务器将响应报文通过TCP连接发送回浏览器。

---

## 五、浏览器接收响应并渲染页面

### 1. 解析响应

浏览器接收到HTTP响应后，解析响应头和响应主体：

- **响应状态码**：判断请求是否成功（例如200 OK）。
- **响应头部**：获取Content-Type、Content-Length、Set-Cookie等信息。
- **响应主体**：通常是HTML、JSON、文件数据等。

### 2. 渲染流程

#### （1）解析HTML，构建DOM树

浏览器从上到下解析HTML文档，生成DOM（Document Object Model）树。

#### （2）解析CSS，生成CSSOM树

- **外部样式表**：通过`<link>`标签引用，需要发送请求获取CSS文件。
- **内部样式表**：`<style>`标签内的CSS。
- **内联样式**：元素的`style`属性。

#### （3）构建渲染树

将DOM树与CSSOM树结合，生成渲染树（Render Tree），包含了可见元素的样式和布局信息。

#### （4）布局（Layout）

浏览器计算每个节点在屏幕中的位置和大小，过程也称为“重排”（Reflow）。

#### （5）绘制（Painting）

将渲染树的各个节点绘制到屏幕上，过程也称为“重绘”（Repaint）。

### 3. 处理资源加载

在解析HTML的过程中，如果遇到以下资源，会进行相应的处理：

- **JavaScript文件**：通过`<script>`标签引用，浏览器会根据标签属性（如`async`、`defer`）决定何时下载和执行。
- **图片、视频等媒体资源**：通过`<img>`、`<video>`等标签引用，浏览器会异步下载。
- **iframe**：嵌入其他页面，会触发新的URL请求。

---

## 六、执行JavaScript代码

JavaScript代码的执行可能会修改DOM树、CSSOM树，进而影响页面的渲染。因此，浏览器需要协调脚本执行和渲染流程：

- **阻塞渲染**：默认情况下，遇到`<script>`标签会阻塞解析和渲染，直到脚本下载并执行完毕。
- **异步加载**：使用`async`或`defer`属性，可以告诉浏览器异步加载脚本，避免阻塞。

---

## 七、缓存机制

浏览器会根据响应头中的缓存策略，对资源进行缓存，以提高后续访问的效率：

- **强缓存**：浏览器直接使用缓存，不与服务器通信。通过`Expires`或`Cache-Control`头部控制。
- **协商缓存**：浏览器向服务器发送请求，询问资源是否有更新。通过`Last-Modified`/`If-Modified-Since`或`ETag`/`If-None-Match`头部实现。

---

## 八、总结（性能优化总体思路）

整体来看，如果我们希望提升网站性能，核心的攻克点有以下两个：

1. 降低资源请求耗时（请求调度，请求流程，资源体积，缓存相关）
2. 降低页面渲染耗时 （渲染树构建相关，JS相关，CSS相关，关于图片加载）

资源请求耗时 + 页面渲染耗时 == 用户访问到页面的耗时。

后面我按照这两个大的思路分别总结。

---